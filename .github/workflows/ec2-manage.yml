name: 'EC2 Management'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - stop
          - start
          - destroy

permissions:
  contents: read
  id-token: write

jobs:
  manage-ec2:
    name: 'Manage EC2 Instances'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
        aws-region: ${{ secrets.aws_region }}
        role-session-name: EC2ManagementSession

    - name: Stop EC2 Instances
      if: github.event.inputs.action == 'stop'
      run: |
        echo "Stopping EC2 instances with tag Project=crime-rate..."
        INSTANCE_IDS=$(aws ec2 describe-instances \
          --filters "Name=instance-state-name,Values=running" "Name=tag:Project,Values=crime-rate" \
          --query "Reservations[*].Instances[*].InstanceId" \
          --output text)

        if [ -z "$INSTANCE_IDS" ]; then
          echo "No running instances found"
        else
          echo "Stopping instances: $INSTANCE_IDS"
          aws ec2 stop-instances --instance-ids $INSTANCE_IDS
          echo "Instances stopped successfully"
        fi

    - name: Start EC2 Instances
      if: github.event.inputs.action == 'start'
      run: |
        echo "Starting EC2 instances with tag Project=crime-rate..."
        INSTANCE_IDS=$(aws ec2 describe-instances \
          --filters "Name=instance-state-name,Values=stopped" "Name=tag:Project,Values=crime-rate" \
          --query "Reservations[*].Instances[*].InstanceId" \
          --output text)

        if [ -z "$INSTANCE_IDS" ]; then
          echo "No stopped instances found"
        else
          echo "Starting instances: $INSTANCE_IDS"
          aws ec2 start-instances --instance-ids $INSTANCE_IDS
          echo "Instances started successfully"
        fi

    - name: Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      run: |
        echo "WARNING: This will destroy ALL infrastructure!"
        terraform init
        terraform destroy -auto-approve
        echo "Infrastructure destroyed successfully"
